<h1 class="text-center">Sales</h1>  

<p id="notice"><%= notice %></p>
<br>
<div class="container">
<table class="table">
  <thead>
    <tr>
      <th>Purchaser name</th>
      <th>Item description</th>
      <th>Item price</th>
      <th>Purchase count</th>
      <th>Merchant address</th>
      <th>Merchant name</th>
      <th colspan="3"></th>
    </tr>
  </thead>

  <tbody>
    <% @sales.each do |sale| %>
      <tr id="content-sales-id">
        <td><%= sale.purchaser_name %></td>
        <td><%= sale.item_description %></td>
        <td><%= sale.item_price %></td>
        <td><%= sale.purchase_count %></td>
        <td><%= sale.merchant_address %></td>
        <td><%= sale.merchant_name %></td>
      </tr>
    <% end %>
  </tbody>
</table>  
</div>
<br>
    <div class="form-group text-center">
        <label for="sale-upload-id">Foto</label>
        <input type="file" id="sale-upload-id" name="photo">
    </div>
<div class="text-center">
  <button class='btn btn-primary' id="btn-add-sale-id"> Add new sale</button>
</div>

<script>
      
$("button").on('click', ()=> {
  let fileReader = new FileReader();
    
  var file = $('#sale-upload-id').prop('files')[0];
  if (!file) {
      alert("Failed to load file");
      return false;
  } 
  
  fileReader.onload = ()=> {

    let lines = fileReader.result.split('\n');
    let header = lines[0].split('\t');
    let json_result = {}

    let result = lines.filter((line,index)=> index > 0 && line.length > 0)
    .map(line => `{${line.split('\t').map((value,index)=> {
      value = isNaN(value) ? `"${value}"` : value;
      return `"${header[index]}": ${value}`.replace(' ', '_');
    }).join(',').split()}}`).map(line => JSON.parse(line));
    
    console.log(result);
   
    $.ajax({
      type: 'POST',
      url: 'http://localhost:3000/sale',
      data: JSON.stringify(result),
      contentType: 'application/json',
      success: data => $("body").html(data),
      error: () => alert("Error to create sales"),
      dataType : "html"
    }); 
  };
 
 fileReader.readAsText(file);

})   

</script> 
